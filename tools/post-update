#!/usr/bin/env bash
#
# 拉取 serv@${zProjId}@${zSelfIpStrAddr}@${zTimeStamp} 分支分代码到 master 分支
# 与服务端进行信息交互

# [ DEBUG ]
printf "\n\n[`date`]" >> /tmp/.____post-deploy.log 2>&1

export PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin"
export HOME=`cat /etc/passwd | grep "^\`whoami\`:" | awk -F: '{print $6}'`

# 由于 git push 会一直等待该勾子执行完毕才会返回，因此放在后台子进程中执行，以缩短两端连接的时间
# git push 完成之后传给 post-update 的参数数量与同批次推送的分支数量相同，
#     参数格式类似：refs/heads/serv refs/heads/serv_SHADOW 的形式，
#     分支的先后顺序与推送方的指令顺序一致，分别对应 $1 $2 ...
(
    zPathOnHost="__PROJ_PATH"
    zMasterAddr="__MASTER_ADDR"
    zMasterPort="__MASTER_PORT"

    zProjOnLinePath="`dirname \`dirname \\\`dirname ${zPathOnHost}\\\`\``/`basename ${zPathOnHost}`"

    zProjId=`echo $1 | awk -F@ '{print $2}'`;
    zSelfIpStrAddr=`echo $1 | awk -F@ '{print $3}' | sed 's/_/:/g'`;  # 传输过程中IPv6 地址中的冒号以 '_' 进行了替换，此处需要还原
    zTimeStamp=`echo $1 | awk -F@ '{print $4}'`
    zServBranchName="serv@${zProjId}@${zSelfIpStrAddr}@${zTimeStamp}"  # 取 serv@...@...@... 分支名称

    # 当前 hook 执行过程中要去掉执行权限，防止以下的git操作触发hook无限循环
    chmod 0444 ${zPathOnHost}/.git/hooks/post-update

    # 'B-': 布署出错；'B3': 已收到推送的内容；'B4': 已确认内容无误；'B5': 布署后重启动作成功
    zTcpReply() {
        ${zPathOnHost}_SHADOW/tools/notice\
            "${zMasterAddr}"\
            "${zMasterPort}"\
            "{\"OpsId\":8,\"ProjId\":${zProjId},\"HostAddr\":\"${zSelfIpStrAddr}\",\"RevSig\":\"${1}\",\"TimeStamp\":${zTimeStamp},\"ReplyType\":\"${2}\",\"content\":\"${3}\"}"
    }

    ##################
    # 进入项目代码库 #
    ##################
    cd $zPathOnHost
    if [[ 0 -ne $? ]]; then
        echo -e "\033[${zServBranchName}] [31;01m项目路径不存在！\033[00m" >> /tmp/.____post-deploy.log
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        exit 255
    fi
    export GIT_DIR="${zPathOnHost}/.git"
    git branch master

    # 获取最新接收的版本号
    zServSig=`git log ${zServBranchName} -1 --format=%H`

    # 检测是否存在重复布署动作
    if [[ 0 -ne `\ls /tmp/.${zProjId}_pid_post-update | wc -l` ]]; then
        if [[ ${zTimeStamp} -eq `tail -1 /tmp/.${zProjId}_pid_post-update` ]]; then  # 同一版本，返回错误
            zTcpReply "${zServSig}" "B-" "duplicate deploy：${zSelfIpStrAddr} `head -2 /tmp/.${zProjId}_pid_post-update | tail -1`"\
                >> /tmp/.____post-deploy.log 2>&1
            chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
            exit 255
        elif [[ ${zTimeStamp} -gt `tail -1 /tmp/.${zProjId}_pid_post-update` ]]; then  # 比正在进行的版本更新，kill 之
            kill -9 `head -1 /tmp/.${zProjId}_pid_post-update`
        else  # 比正在进行的版本更老，更论上不可能出现
            zTcpReply "${zServSig}" "B-" "delay deploy：${zServBranchName}"\
                >> /tmp/.____post-deploy.log 2>&1
            chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
            exit 255
        fi
    fi

    # 清除可能存在的由于 git 崩溃残留的锁文件
    rm -f ${zPathOnHost}/.git/index.lock
    rm -f ${zPathOnHost}_SHADOW/.git/index.lock

    # 运行期间将自身 Pid、Ip、TimeStamp 等存入文件，用于防止同一项目的多个 post-update 进程并行带来混乱
    echo "$$" > /tmp/.${zProjId}_pid_post-update
    echo "${zSelfIpStrAddr}" >> /tmp/.${zProjId}_pid_post-update
    echo "${zTimeStamp}" >> /tmp/.${zProjId}_pid_post-update

    # 通知服务端已收到代码；此时尚未确认正确性
    zTcpReply "${zServSig}" "B3" ""\
        >> /tmp/.____post-deploy.log 2>&1 &

    ##################
    # 进入 SHADOW 库 #
    ##################
    cd ${zPathOnHost}_SHADOW
    export GIT_DIR="${zPathOnHost}_SHADOW/.git"
    git branch master
    git checkout master
    git pull ${zPathOnHost}/.git ${zServBranchName}_SHADOW:master
    if [[ 0 -ne $? ]]; then
        \ls -a | grep -vE '^(\.|\.\.|\.git)$' | xargs rm -rf
        git stash
        git stash clear
        git pull --force ${zPathOnHost}/.git ${zServBranchName}_SHADOW:master 2>${zPathOnHost}_SHADOW/errlog
        if [[ 0 -ne $? ]]; then
            sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
            sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
            zTcpReply "${zServSig}" "B-" "git pull failed, ${zPathOnHost}_SHADOW: `cat ${zPathOnHost}_SHADOW/errlog`"\
                >> /tmp/.____post-deploy.log 2>&1
            chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
            rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
            exit 255
        fi
    fi

    git reset --hard 2>${zPathOnHost}_SHADOW/errlog
    if [[ 0 -ne $? ]]; then
        sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
        sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
        sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
        sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
        zTcpReply "${zServSig}" "B-" "git reset failed, ${zPathOnHost}_SHADOW: `cat ${zPathOnHost}_SHADOW/errlog`"\
            >> /tmp/.____post-deploy.log 2>&1
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    fi

    ############################
    # 进入项目代码库，执行布署 #
    ############################
    cd $zPathOnHost
    if [[ 0 -ne $? ]]; then
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    fi
    export GIT_DIR="${zPathOnHost}/.git"
    git checkout master

    # 检测必要的路径下是存在权限异常的文件
    mkdir -p ${zProjOnLinePath} ${zPathOnHost} ${zPathOnHost}_SHADOW
    chown `whoami` ${zProjOnLinePath} ${zPathOnHost} ${zPathOnHost}_SHADOW 2>${zPathOnHost}_SHADOW/errlog
    if [[ 0 -ne $? ]]; then
        sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
        sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
        sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
        sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
        zTcpReply "${zServSig}" "B-" "permission denied, ${zProjOnLinePath} or `dirname ${zPathOnHost}`: `cat ${zPathOnHost}_SHADOW/errlog`"\
            >> /tmp/.____post-deploy.log 2>&1
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rmdir ${zProjOnLinePath} ${zPathOnHost} ${zPathOnHost}_SHADOW  # 权限无误，清除创建的空目录
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    fi
    rmdir ${zProjOnLinePath} ${zPathOnHost} ${zPathOnHost}_SHADOW  # 权限无误，清除创建的空目录

    git reset -q --hard ${zServBranchName}
    if [[ 0 -ne $? ]]; then
        # \ls -a | grep -vE '^(\.|\.\.|\.git)$' | xargs rm -rf
        git stash
        git stash clear
        git reset -q --hard ${zServBranchName} 2>${zPathOnHost}_SHADOW/errlog
        if [[ 0 -ne $? ]]; then
            sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
            sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
            zTcpReply "${zServSig}" "B-" "git reset failed, ${zPathOnHost}: `cat ${zPathOnHost}_SHADOW/errlog`"\
                >> /tmp/.____post-deploy.log 2>&1
            chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
            rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
            exit 255
        fi
    fi

    # 校验布署结果
    cd ../../`basename ${zPathOnHost}`/.git  # 兼容旧版项目库
    if [[ 0 -eq $? ]]; then
        cd ..
        export GIT_DIR="`pwd`/.git"
        git checkout master
        git pull --force ${zPathOnHost}/.git ${zServBranchName}:${zServBranchName}
        git reset -q --hard ${zServBranchName}
    else
        export GIT_DIR="${zPathOnHost}/.git"
    fi

    zMasterSig=`git log master -1 --format=%H`
    if [[ "$zMasterSig" != "$zServSig" ]]; then  # 检查两个分支 git log 是否一致
        zTcpReply "${zServSig}" "B-" "code version inconsistent(git log): branch ${zServBranchName} != branch master"\
            >> /tmp/.____post-deploy.log 2>&1
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    elif [[ 0 -ne "`git status --short --untracked-files=no | wc -l`" ]]; then  # 检查是否存在文件不一致现象(忽略未被 git 管理的新文件，如：log 等)
        zTcpReply "${zServSig}" "B-" "work area inconsistent(git status): `pwd`"\
            >> /tmp/.____post-deploy.log 2>&1
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    fi

    if [[ 0 -eq `ls -d ${zProjOnLinePath} | wc -l` ]]; then # 创建项目路径软链接
        ln -sT ${zPathOnHost} ${zProjOnLinePath}
        if [[ 0 -ne $? ]]; then
            zTcpReply "${zServSig}" "B-" "创建软链接错误，请检查项目路径权限: ${zProjOnLinePath}"\
                >> /tmp/.____post-deploy.log 2>&1
            chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
            rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
            exit 255
        fi
    elif [[ ('l' != `ls -l ${zProjOnLinePath} | grep -o '^l'`) # 检测是否有废弃的残留文件，若存在，则抛出错误
        || ((${zPathOnHost} != `readlink -q ${zProjOnLinePath}`) && (`dirname \`dirname ${zPathOnHost}\``/`basename ${zPathOnHost}` != `readlink -q ${zProjOnLinePath}`)) ]]; then
        zTcpReply "${zServSig}" "B-" "既存路径(或链接)与项目路径冲突，请手动删除后重试布署: ${zProjOnLinePath}"\
            >> /tmp/.____post-deploy.log 2>&1
        chmod 0755 ${zPathOnHost}/.git/hooks/post-update  # 退出之前还原权限
        rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
        exit 255
    fi

    rm -rf ${zProjOnLinePath}_SHADOW  # 清理可能存在的旧版布署系统的遗留文件

    # 通知服务端已确认收到的内容准确无误
    zTcpReply ${zMasterSig} "B4" ""\
        >> /tmp/.____post-deploy.log 2>&1 &

    # 更新开机自布署脚本
    cp ${zPathOnHost}_SHADOW/tools/____req-deploy.sh ${HOME}/.____req-deploy.sh

    # 执行用户自定义的布署后动作：____post-deploy.sh
    cd ${zProjOnLinePath}
    if [[ 0 -ne `\ls ${zPathOnHost}_SHADOW/____post-deploy.sh | wc -l` ]]; then
        chmod 0755 ${zPathOnHost}_SHADOW/____post-deploy.sh
        ${zPathOnHost}_SHADOW/____post-deploy.sh 2>${zPathOnHost}_SHADOW/errlog
        if [[ 0 -ne $? ]]; then
            sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
            sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
            zTcpReply ${zMasterSig} "B-" "[cmd exec failed]: `cat ${zPathOnHost}_SHADOW/errlog`"\
                >> /tmp/.____post-deploy.log 2>&1
            rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
            exit 255
        fi
    fi

    if [[ 0 -ne `\ls ${zProjOnLinePath}/____post-deploy.sh | wc -l` ]]; then
        chmod 0755 ____post-deploy.sh
        ./____post-deploy.sh 2>${zPathOnHost}_SHADOW/errlog
        if [[ 0 -ne $? ]]; then
            sed -i 's/[[:blank:]]\+/ /g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\'/|/g" ${zPathOnHost}_SHADOW/errlog
            sed -i 's/"/|/g' ${zPathOnHost}_SHADOW/errlog
            sed -i "s/\n/;/g" ${zPathOnHost}_SHADOW/errlog
            zTcpReply ${zMasterSig} "B-" "____post-deploy.sh failed: `cat ${zPathOnHost}_SHADOW/errlog`"\
                >> /tmp/.____post-deploy.log 2>&1
            rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
            exit 255
        fi
    fi

    ###########################################
    # 布署成功：'B+' 用于标识这是布署状态回复 #
    ###########################################
    zTcpReply ${zMasterSig} "B5" ""\
        >> /tmp/.____post-deploy.log 2>&1

    # 退出之前还原权限
    chmod 0755 ${zPathOnHost}/.git/hooks/post-update

    rm /tmp/.${zProjId}_pid_post-update  # 删除自身 pid 文件
) &
